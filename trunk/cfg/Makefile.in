VERSION_DIR   := @versiondir@
INCLUDE_DIR   := @includedir@$(VERSION_DIR)
LIB_DIR       := @libdir@$(VERSION_DIR)
SRC_DIR       := @srcdir@$(VERSION_DIR)
TOOLS_DIR     := @libdir@$(VERSION_DIR)/tools/lib
STAGING_DIR   := build
INSTALL_DIR   := $(LIB_DIR)/dynext
PMC_DIR       := src/pmc
DECNUMBER_DIR := src/decNumber

# Set up extensions
LOAD_EXT      := @load_ext@
O             := @o@

# Setup some commands
MAKE          := @make_c@
PERL          := @perl@
RM_F          := @rm_f@
RM_RF         := @rm_rf@
CHMOD         := @chmod@
MKPATH        := @mkpath@
CP            := @cp@
MV            := @mv@
CC            := @cc@ -c
LD            := @ld@
LDFLAGS       := @ldflags@ @ld_debug@
LD_LOAD_FLAGS := @ld_load_flags@
#IF(@bigendian@):ENDIAN        := -DDECLITEND=0
#ELSE:ENDIAN        := -DDECLITEND=1
CFLAGS        := @ccflags@ @cc_shared@ @cc_debug@ @ccwarn@ @cc_hasjit@\
                 @cg_flag@ @gc_flag@ $(ENDIAN) -DDECUSE64=0 -DDECDPUN=4\
                 -DDECNUMDIGITS=512 -DDECSUBSET=0
CC_OUT        := @cc_o_out@
LD_OUT        := @ld_out@
#IF(parrot_is_shared):LIBPARROT     := @inst_libparrot_ldflags@
#ELSE:LIBPARROT     :=

PMC2C_INCLUDES  := --include $(SRC_DIR) --include $(SRC_DIR)/pmc \
                   --include $(STAGING_DIR)
PMC2C           := $(PERL) $(LIB_DIR)/tools/build/pmc2c.pl
PMC2CD          := $(PMC2C) --dump $(PMC2C_INCLUDES)
PMC2CC          := $(PMC2C) --c $(PMC2C_INCLUDES)

INCLUDES        := -I$(INCLUDE_DIR) -I$(INCLUDE_DIR)/pmc
LINKARGS        := $(LDFLAGS) $(LD_LOAD_FLAGS) $(LIBPARROT)

PMC_DEPS := \
    $(STAGING_DIR)/decbase.pmc \
    $(STAGING_DIR)/decnumcontext.pmc \
    $(STAGING_DIR)/decnum.pmc \
    $(STAGING_DIR)/decintcontext.pmc \
    $(STAGING_DIR)/decint.pmc

# the default target
all: $(STAGING_DIR)/decnum_group$(LOAD_EXT)

$(PMC_DEPS):
	$(CP) $(PMC_DIR)/*pmc $(STAGING_DIR)

$(STAGING_DIR)/decnum_group.c: $(PMC_DEPS) $(STAGING_DIR)/decContext$(O) \
                               $(STAGING_DIR)/decNumber$(O)
	$(PMC2C) --library decnum_group --c \
            $(STAGING_DIR)/decintcontext.pmc $(STAGING_DIR)/decint.pmc \
            $(STAGING_DIR)/decnumcontext.pmc $(STAGING_DIR)/decnum.pmc \
            $(STAGING_DIR)/decbase.pmc
	$(MV) decnum_group* $(STAGING_DIR)

$(STAGING_DIR)/lib-decnum_group$(O): $(STAGING_DIR)/decnum_group.c
	$(CC) $(CC_OUT)$(STAGING_DIR)/lib-decnum_group$(O) $(INCLUDES) \
              $(CFLAGS) $(STAGING_DIR)/decnum_group.c

$(STAGING_DIR)/decnum_group$(LOAD_EXT): $(STAGING_DIR)/decbase$(O) \
    $(STAGING_DIR)/decNumber$(O) $(STAGING_DIR)/decContext$(O) \
    $(STAGING_DIR)/decnumcontext$(O) $(STAGING_DIR)/decnum$(O) \
    $(STAGING_DIR)/decintcontext$(O) $(STAGING_DIR)/decint$(O) \
    $(STAGING_DIR)/lib-decnum_group$(O) $(DECNUM_OBJS)
	$(LD) $(LD_OUT)$(STAGING_DIR)/decnum_group$(LOAD_EXT) \
              $(STAGING_DIR)/decNumber$(O) $(STAGING_DIR)/decContext$(O) \
              $(STAGING_DIR)/decintcontext$(O) $(STAGING_DIR)/decint$(O) \
              $(STAGING_DIR)/decnumcontext$(O) $(STAGING_DIR)/decnum$(O) \
              $(STAGING_DIR)/lib-decnum_group$(O) \
              $(STAGING_DIR)/decbase$(O) $(LINKARGS)

$(STAGING_DIR)/decintcontext.dump: $(STAGING_DIR)/decintcontext.pmc \
    $(STAGING_DIR)/decnumcontext$(O)
	$(PMC2CD) $(STAGING_DIR)/decintcontext.pmc

$(STAGING_DIR)/decintcontext.c: $(STAGING_DIR)/decintcontext.dump
	$(PMC2CC) $(STAGING_DIR)/decintcontext.pmc

$(STAGING_DIR)/decintcontext$(O): $(STAGING_DIR)/decintcontext.c
	$(CC) $(CC_OUT)$(STAGING_DIR)/decintcontext$(O) $(INCLUDES) \
              $(CFLAGS) $(STAGING_DIR)/decintcontext.c

$(STAGING_DIR)/decint.dump: $(STAGING_DIR)/decint.pmc \
    $(STAGING_DIR)/decnum$(O)
	$(PMC2CD) $(STAGING_DIR)/decint.pmc

$(STAGING_DIR)/decint.c: $(STAGING_DIR)/decint.dump 
	$(PMC2CC) $(STAGING_DIR)/decint.pmc

$(STAGING_DIR)/decint$(O): $(STAGING_DIR)/decint.c
	$(CC) $(CC_OUT)$(STAGING_DIR)/decint$(O) $(INCLUDES) \
              $(CFLAGS) $(STAGING_DIR)/decint.c

$(STAGING_DIR)/decnumcontext.dump: $(STAGING_DIR)/decnumcontext.pmc \
    $(STAGING_DIR)/decbase$(O)
	$(PMC2CD) $(STAGING_DIR)/decnumcontext.pmc

$(STAGING_DIR)/decnumcontext.c: $(STAGING_DIR)/decnumcontext.dump
	$(PMC2CC) $(STAGING_DIR)/decnumcontext.pmc

$(STAGING_DIR)/decnumcontext$(O): $(STAGING_DIR)/decnumcontext.c
	$(CC) $(CC_OUT)$(STAGING_DIR)/decnumcontext$(O) $(INCLUDES) \
              $(CFLAGS) $(STAGING_DIR)/decnumcontext.c

$(STAGING_DIR)/decnum.dump: $(STAGING_DIR)/decnum.pmc \
    $(STAGING_DIR)/decbase$(O)
	$(PMC2CD) $(STAGING_DIR)/decnum.pmc

$(STAGING_DIR)/decnum.c: $(STAGING_DIR)/decnum.dump
	$(PMC2CC) $(STAGING_DIR)/decnum.pmc

$(STAGING_DIR)/decnum$(O): $(STAGING_DIR)/decnum.c
	$(CC) $(CC_OUT)$(STAGING_DIR)/decnum$(O) $(INCLUDES) \
              $(CFLAGS) $(STAGING_DIR)/decnum.c

$(STAGING_DIR)/decbase.dump: $(STAGING_DIR)/decbase.pmc
	$(PMC2CD) $(STAGING_DIR)/decbase.pmc

$(STAGING_DIR)/decbase.c: $(STAGING_DIR)/decbase.dump
	$(PMC2CC) $(STAGING_DIR)/decbase.pmc

$(STAGING_DIR)/decbase$(O): $(STAGING_DIR)/decbase.c
	$(CC) $(CC_OUT)$(STAGING_DIR)/decbase$(O) $(INCLUDES) \
              $(CFLAGS) $(STAGING_DIR)/decbase.c

$(STAGING_DIR)/decContext$(O): $(DECNUMBER_DIR)/decContext.c \
    $(DECNUMBER_DIR)/decContext.h
	$(CC) $(CFLAGS) $(CC_OUT)$(STAGING_DIR)/decContext$(O) \
              $(DECNUMBER_DIR)/decContext.c

$(STAGING_DIR)/decNumber$(O): $(DECNUMBER_DIR)/decNumber.c \
    $(DECNUMBER_DIR)/decNumber.h $(DECNUMBER_DIR)/decContext.h
	$(CC) $(CFLAGS) $(CC_OUT)$(STAGING_DIR)/decNumber$(O) \
              $(DECNUMBER_DIR)/decNumber.c

# This is a listing of all targets, that are meant to be called by users
help:
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "  all:               Build the dynpmcs."
	@echo "                     This is the default."
	@echo "  install:           Install the installable targets."
	@echo "  uninstall:         Un-install the above targets."
	@echo ""
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleaning up."
	@echo "  realclean:         Removes also files generated by 'Configure.pir'"
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""

test: all
	$(PERL) t/harness

install: all
#IF(cygwin or hpux):	CHMOD 0775 $(STAGING_DIR)/decnum_group$(LOAD_EXT)
	$(CP) $(STAGING_DIR)/decnum_group$(LOAD_EXT) $(INSTALL_DIR)
	$(CP) inc/decnum.pasm $(LIB_DIR)/include

uninstall:
	$(RM_F) $(INSTALL_DIR)/decnum_group$(LOAD_EXT)
	$(RM_F) $(LIB_DIR)/include/decnum.pasm

clean:
	$(RM_RF) $(STAGING_DIR)/*

realclean: clean
	$(RM_F) Makefile aux/decTest/Makefile

# Local variables:
#   mode: makefile
# End:
# vim: ft=make:
