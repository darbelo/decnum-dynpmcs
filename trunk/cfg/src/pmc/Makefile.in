## $Id$

# values from parrot_config
VERSION_DIR   := @versiondir@
INCLUDE_DIR   := @includedir@$(VERSION_DIR)
LIB_DIR       := @libdir@$(VERSION_DIR)
SRC_DIR       := @srcdir@$(VERSION_DIR)
TOOLS_DIR     := @libdir@$(VERSION_DIR)/tools/lib
STAGING_DIR   := ../../build
INSTALL_DIR   := $(LIB_DIR)/dynext

# Set up extensions
LOAD_EXT      := @load_ext@
O             := @o@

# Setup some commands
PERL          := @perl@
RM_F          := @rm_f@
CHMOD         := @chmod@
CP            := @cp@
CC            := @cc@ -c
LD            := @ld@
LDFLAGS       := @ldflags@ @ld_debug@
LD_LOAD_FLAGS := @ld_load_flags@
#IF(@bigendian@):ENDIAN        := -DDECLITEND=0
#ELSE:ENDIAN        := -DDECLITEND=1
CFLAGS        := @ccflags@ @cc_shared@ @cc_debug@ @ccwarn@ @cc_hasjit@\
                 @cg_flag@ @gc_flag@ $(ENDIAN) -DDECUSE64=0 -DDECDPUN=4\
                 -DDECNUMDIGITS=512 -DDECSUBSET=0
CC_OUT        := @cc_o_out@
LD_OUT        := @ld_out@
#IF(parrot_is_shared):LIBPARROT     := @inst_libparrot_ldflags@
#ELSE:LIBPARROT     :=

PMC2C_INCLUDES  := --include $(SRC_DIR) --include $(SRC_DIR)/pmc
PMC2C           := $(PERL) $(LIB_DIR)/tools/build/pmc2c.pl
PMC2CD          := $(PMC2C) --dump $(PMC2C_INCLUDES)
PMC2CC          := $(PMC2C) --c $(PMC2C_INCLUDES)

INCLUDES        := -I$(INCLUDE_DIR) -I$(INCLUDE_DIR)/pmc
LINKARGS        := $(LDFLAGS) $(LD_LOAD_FLAGS) $(LIBPARROT)

DECNUM_OBJS := \
  $(STAGING_DIR)/decContext$(O) $(STAGING_DIR)/decNumber$(O)

CLEANUPS := \
  "*$(LOAD_EXT)" \
  "*$(O)" \
  "*.c" \
  "pmc*.h" \
  "decnum_group.h" \
  "*.dump" \
#IF(win32):  "*.exp" \
#IF(win32):  "*.ilk" \
#IF(win32):  "*.manifext" \
#IF(win32):  "*.pdb" \
#IF(win32):  "*.lib" \
  $(STAGING_DIR)/decnum$(LOAD_EXT) \
  $(STAGING_DIR)/decnumcontext$(LOAD_EXT)

all: staging

decnum_group.c: decnumcontext.pmc decnum.pmc decintcontext.pmc\
                decint.pmc decbase.pmc
	$(PMC2C) --library decnum_group --c decintcontext.pmc decint.pmc \
        decnumcontext.pmc decnum.pmc decbase.pmc

lib-decnum_group$(O): decnum_group.c
	$(CC) $(CC_OUT)lib-decnum_group$(O)  $(INCLUDES) $(CFLAGS) \
        decnum_group.c

decnum_group$(LOAD_EXT): decbase$(O) decnumcontext$(O) decintcontext$(O)\
                         decnum$(O) decint$(O) lib-decnum_group$(O)
	 $(LD) $(LD_OUT)decnum_group$(LOAD_EXT) decintcontext$(O) \
          decint$(O) decnumcontext$(O) decnum$(O) lib-decnum_group$(O) \
          decbase$(O) $(DECNUM_OBJS) $(LINKARGS)

decintcontext.dump: decintcontext.pmc decnumcontext$(O)
	$(PMC2CD) decintcontext.pmc

decintcontext.c: decintcontext.dump
	$(PMC2CC) decintcontext.pmc

decintcontext$(O): decintcontext.c
	$(CC) $(CC_OUT)decintcontext$(O) $(INCLUDES) $(CFLAGS) decintcontext.c

decint.dump: decint.pmc decnum$(O)
	$(PMC2CD) decint.pmc

decint.c: decint.dump 
	$(PMC2CC) decint.pmc

decint$(O): decint.c
	$(CC) $(CC_OUT)decint$(O) $(INCLUDES) $(CFLAGS) decint.c

decnumcontext.dump: decnumcontext.pmc decbase$(O)
	$(PMC2CD) decnumcontext.pmc

decnumcontext.c: decnumcontext.dump
	$(PMC2CC) decnumcontext.pmc

decnumcontext$(O): decnumcontext.c
	$(CC) $(CC_OUT)decnumcontext$(O) $(INCLUDES) $(CFLAGS) decnumcontext.c

decnum.dump: decnum.pmc decbase$(O)
	$(PMC2CD) decnum.pmc

decnum.c: decnum.dump
	$(PMC2CC) decnum.pmc

decnum$(O): decnum.c
	$(CC) $(CC_OUT)decnum$(O) $(INCLUDES) $(CFLAGS) decnum.c

decbase.dump: decbase.pmc
	$(PMC2CD) decbase.pmc

decbase.c: decbase.dump
	$(PMC2CC) decbase.pmc

decbase$(O): decbase.c
	$(CC) $(CC_OUT)decbase$(O) $(INCLUDES) $(CFLAGS) decbase.c

staging: decnum_group$(LOAD_EXT)
#IF(cygwin or hpux):	CHMOD 0775 "*$(LOAD_EXT)"
	$(CP) "*$(LOAD_EXT)" $(STAGING_DIR)

clean:
	$(RM_F) $(CLEANUPS)

realclean:
	$(RM_F) $(CLEANUPS) Makefile

# Local variables:
#   mode: makefile
# End:
# vim: ft=make:
