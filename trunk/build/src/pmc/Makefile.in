## $Id$

# values from parrot_config
VERSION_DIR   := @versiondir@
INCLUDE_DIR   := @includedir@$(VERSION_DIR)
LIB_DIR       := @libdir@$(VERSION_DIR)
SRC_DIR       := @srcdir@$(VERSION_DIR)
TOOLS_DIR     := @libdir@$(VERSION_DIR)/tools/lib
STAGING_DIR   := @build_dir@/runtime/parrot/dynext
INSTALL_DIR   := $(LIB_DIR)/dynext

# Set up extensions
LOAD_EXT      := @load_ext@
O             := @o@

# Setup some commands
PERL          := @perl@
RM_F          := @rm_f@
CHMOD         := @chmod@
CP            := @cp@
CC            := @cc@ -c
LD            := @ld@
LDFLAGS       := @ldflags@ @ld_debug@
LD_LOAD_FLAGS := @ld_load_flags@
#IF(@bigendian@):ENDIAN        := -DDECLITEND=0
#ELSE:ENDIAN        := -DDECLITEND=1
CFLAGS        := @ccflags@ @cc_shared@ @cc_debug@ @ccwarn@ @cc_hasjit@\
                 @cg_flag@ @gc_flag@ $(ENDIAN) -DDECUSE64=0 -DDECDPUN=4
CC_OUT        := @cc_o_out@
LD_OUT        := @ld_out@
#IF(parrot_is_shared):LIBPARROT     := @inst_libparrot_ldflags@
#ELSE:LIBPARROT     :=

PMC2C_INCLUDES  := --include $(SRC_DIR) --include $(SRC_DIR)/pmc
PMC2C           := $(PERL) $(LIB_DIR)/tools/build/pmc2c.pl
PMC2CD          := $(PMC2C) --dump $(PMC2C_INCLUDES)
PMC2CC          := $(PMC2C) --c $(PMC2C_INCLUDES)

INCLUDES        := -I$(INCLUDE_DIR) -I$(INCLUDE_DIR)/pmc
LINKARGS        := $(LDFLAGS) $(LD_LOAD_FLAGS) $(LIBPARROT)

DECNUM_OBJS := \
  decnum$(O) ../decNumber/decContext$(O) ../decNumber/decQuad$(O)

DECCONTEXT_OBJS := \
  deccontext$(O) ../decNumber/decContext$(O)

CLEANUPS := \
  "*$(LOAD_EXT)" \
  "*$(O)" \
  "*.c" \
  "*.h" \
  "*.dump" \
#IF(win32):  "*.exp" \
#IF(win32):  "*.ilk" \
#IF(win32):  "*.manifext" \
#IF(win32):  "*.pdb" \
#IF(win32):  "*.lib" \
  $(STAGING_DIR)/decnum$(LOAD_EXT) \
  $(STAGING_DIR)/deccontext$(LOAD_EXT)

all: staging

decnum.dump: decnum.pmc
	$(PMC2CD) decnum.pmc

decnum.c: decnum.dump
	$(PMC2CC) decnum.pmc

decnum$(O): decnum.c
	$(CC) $(CC_OUT)decnum$(O) $(INCLUDES) $(CFLAGS) decnum.c

decnum$(LOAD_EXT): decnum$(O)
	$(LD) $(LD_OUT)decnum$(LOAD_EXT) $(DECNUM_OBJS) $(LINKARGS)

decnum_group$(LOAD_EXT): deccontext$(O) decnum2$(O) lib-decnum_group$(O)
	 $(LD) $(LD_OUT)decnum_group$(LOAD_EXT) $(DECNUM_OBJS) \
         deccontext$(O) decnum2$(O) lib-decnum_group$(O) $(LINKARGS)

lib-decnum_group$(O): decnum_group.c
	$(CC) $(CC_OUT)lib-decnum_group$(O)  $(INCLUDES) $(CFLAGS) \
        decnum_group.c

decnum_group.c: deccontext.pmc decnum2.pmc decbase.pmc
	$(PMC2C) --library decnum_group --c deccontext.pmc decnum2.pmc \
        decbase.pmc

deccontext.dump: deccontext.pmc decbase$(O)
	$(PMC2CD) deccontext.pmc

deccontext.c: deccontext.dump
	$(PMC2CC) deccontext.pmc

deccontext$(O): deccontext.c
	$(CC) $(CC_OUT)deccontext$(O) $(INCLUDES) $(CFLAGS) deccontext.c

decnum2.dump: decnum2.pmc decbase$(O)
	$(PMC2CD) decnum2.pmc

decnum2.c: decnum2.dump
	$(PMC2CC) decnum2.pmc

decnum2$(O): decnum2.c
	$(CC) $(CC_OUT)decnum2$(O) $(INCLUDES) $(CFLAGS) decnum2.c

decbase.dump: decbase.pmc
	$(PMC2CD) decbase.pmc

decbase.c: decbase.dump
	$(PMC2CC) decbase.pmc

decbase$(O): decnum.c
	$(CC) $(CC_OUT)decbase$(O) $(INCLUDES) $(CFLAGS) decnum.c

staging: decnum$(LOAD_EXT) decnum_group$(LOAD_EXT)
#IF(cygwin or hpux):	CHMOD 0775 "*$(LOAD_EXT)"
	$(CP) "*$(LOAD_EXT)" $(STAGING_DIR)

install: staging
#IF(cygwin or hpux):	CHMOD 0775 "*$(LOAD_EXT)"
	$(CP) "*$(LOAD_EXT)" $(INSTALL_DIR)

uninstall:
	$(RM_F) $(INSTALL_DIR)/decnum$(LOAD_EXT)
	$(RM_F) $(INSTALL_DIR)/deccontext$(LOAD_EXT)

clean:
	$(RM_F) $(CLEANUPS)

realclean:
	$(RM_F) $(CLEANUPS) Makefile

# Local variables:
#   mode: makefile
# End:
# vim: ft=make:
