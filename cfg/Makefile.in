VERSION_DIR   := @versiondir@
INCLUDE_DIR   := @includedir@$(VERSION_DIR)
LIB_DIR       := @libdir@$(VERSION_DIR)
SRC_DIR       := @srcdir@$(VERSION_DIR)
TOOLS_DIR     := @libdir@$(VERSION_DIR)/tools/lib
STAGING_DIR   := build
INSTALL_DIR   := $(LIB_DIR)/dynext
PMC_DIR       := src/pmc
DECNUMBER_DIR := src/decNumber

# Set up extensions
LOAD_EXT      := @load_ext@
O             := @o@

# Setup some commands
MAKE          := @make_c@
PERL          := @perl@
RM_F          := @rm_f@
RM_RF         := @rm_rf@
CHMOD         := @chmod@
MKPATH        := @mkpath@
CP            := @cp@
CC            := @cc@ -c
LD            := @ld@
LDFLAGS       := @ldflags@ @ld_debug@
LD_LOAD_FLAGS := @ld_load_flags@
#IF(@bigendian@):ENDIAN        := -DDECLITEND=0
#ELSE:ENDIAN        := -DDECLITEND=1
CFLAGS        := @ccflags@ @cc_shared@ @cc_debug@ @ccwarn@ @cc_hasjit@\
                 @cg_flag@ @gc_flag@ $(ENDIAN) -DDECUSE64=0 -DDECDPUN=4\
                 -DDECNUMDIGITS=512 -DDECSUBSET=0
CC_OUT        := @cc_o_out@
LD_OUT        := @ld_out@
#IF(parrot_is_shared):LIBPARROT     := @inst_libparrot_ldflags@
#ELSE:LIBPARROT     :=

PMC2C_INCLUDES  := --include $(SRC_DIR) --include $(SRC_DIR)/pmc
PMC2C           := $(PERL) $(LIB_DIR)/tools/build/pmc2c.pl
PMC2CD          := $(PMC2C) --dump $(PMC2C_INCLUDES)
PMC2CC          := $(PMC2C) --c $(PMC2C_INCLUDES)

INCLUDES        := -I$(INCLUDE_DIR) -I$(INCLUDE_DIR)/pmc
LINKARGS        := $(LDFLAGS) $(LD_LOAD_FLAGS) $(LIBPARROT)

PMC_DEPS := \
    $(PMC_DIR)/decbase.pmc \
    $(PMC_DIR)/decnumcontext.pmc \
    $(PMC_DIR)/decnum.pmc

# the default target
all: pmc $(STAGING_DIR)

$(STAGING_DIR):
	$(MKPATH) $(STAGING_DIR)

pmc: $(PMC_DEPS) $(STAGING_DIR)/decContext$(O) \
     $(STAGING_DIR)/decNumber$(O) $(STAGING_DIR)
	$(MAKE) $(PMC_DIR)

$(STAGING_DIR)/decContext$(O): $(DECNUMBER_DIR)/decContext.c \
                      $(DECNUMBER_DIR)/decContext.h $(STAGING_DIR)
	$(CC) $(CFLAGS) $(CC_OUT)$(STAGING_DIR)/decContext$(O) \
              $(DECNUMBER_DIR)/decContext.c

$(STAGING_DIR)/decNumber$(O): $(DECNUMBER_DIR)/decNumber.c \
                              $(DECNUMBER_DIR)/decNumber.h \
                              $(DECNUMBER_DIR)/decContext.h
	$(CC) $(CFLAGS) $(CC_OUT)$(STAGING_DIR)/decNumber$(O) \
              $(DECNUMBER_DIR)/decNumber.c

# This is a listing of all targets, that are meant to be called by users
help:
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "  pmc:               Build the dynpmcs."
	@echo "                     This is the default."
	@echo "  install:           Install the installable targets and docs."
	@echo ""
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo "  testclean:         Clean up test results."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleaning up."
	@echo "  realclean:         Removes also files generated by 'Configure.pl'"
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""

test: pmc
	$(PERL) t/harness

install: pmc
#IF(cygwin or hpux):	CHMOD 0775 "*$(LOAD_EXT)"
	$(CP) "$(STAGING_DIR)/decnum_group$(LOAD_EXT)" $(INSTALL_DIR)
	$(CP) "inc/decnum.pasm" $(LIB_DIR)/include

uninstall:
	$(RM_F) $(INSTALL_DIR)/decnum_group$(LOAD_EXT)
	$(RM_F) $(LIB_DIR)/include/decnum.pasm

clean:
	$(MAKE) $(PMC_DIR) clean 
	$(RM_RF) $(STAGING_DIR)

realclean: clean
	$(MAKE) $(PMC_DIR) realclean
	$(RM_F) Makefile aux/decTest/Makefile

# Local variables:
#   mode: makefile
# End:
# vim: ft=make:
