# values from parrot_config
BUILD_DIR     = @build_dir@
LOAD_EXT      = @load_ext@
O             = @o@
EXE           = @exe@
MAKE          = @make_c@
PERL          = @perl@
RM_F          = @rm_f@
HAS_ICU       = @has_icu@

# Various paths
PARROT_DYNEXT = $(BUILD_DIR)/runtime/parrot/dynext
PERL6GRAMMAR  = $(BUILD_DIR)/runtime/parrot/library/PGE/Perl6Grammar.pbc
NQP           = $(BUILD_DIR)/compilers/nqp/nqp.pbc
PCT           = $(BUILD_DIR)/runtime/parrot/library/PCT.pbc
PMC_DIR       = src/pmc
OPSDIR        = src/ops
OPSLIB        = dectest
OPS_FILE      = src/ops/dectest.ops

# Setup some commands
PARROT        = $(BUILD_DIR)/parrot$(EXE)
CAT           = $(PERL) -MExtUtils::Command -e cat
BUILD_DYNPMC  = $(PERL) $(BUILD_DIR)/tools/build/dynpmc.pl
BUILD_DYNOPS  = $(PERL) $(BUILD_DIR)/tools/build/dynoplibs.pl
PBC_TO_EXE    = $(BUILD_DIR)/pbc_to_exe$(EXE)

SOURCES = dectest.pir \
  src/gen_grammar.pir \
  src/gen_actions.pir \
  src/gen_builtins.pir

# PMCS        = dectest
# PMC_SOURCES = $(PMC_DIR)/dectest.pmc
# DECTEST_GROUP  = $(PMC_DIR)/dectest_group$(LOAD_EXT)

CLEANUPS = \
  dectest.pbc \
  dectest.c \
  *.manifest \
  *.pdb \
  dectest$(O) \
  dectest$(EXE) \
  src/gen_*.pir \
  src/gen_*.pm

# the default target
all: dectest$(EXE)

installable: installable_dectest$(EXE)

##  targets for building a standalone executable
dectest$(EXE): dectest.pbc
	$(PBC_TO_EXE) dectest.pbc
	@win32_libparrot_copy@

installable_dectest$(EXE): dectest.pbc
	$(PBC_TO_EXE) dectest.pbc --install

# the compiler .pbc
dectest.pbc: Makefile $(PARROT) $(SOURCES) $(BUILTINS_PIR)
	$(PARROT) $(PARROT_ARGS) -o dectest.pbc dectest.pir

src/gen_grammar.pir: $(PARROT) $(PERL6GRAMMAR) src/pct/grammar.pg
	$(PARROT) $(PARROT_ARGS) $(PERL6GRAMMAR) \
	    --output=src/gen_grammar.pir \
	    src/pct/grammar.pg

src/gen_actions.pir: $(PARROT) $(NQP) $(PCT) src/pct/actions.pm
	$(PARROT) $(PARROT_ARGS) $(NQP) --output=src/gen_actions.pir \
	    --encoding=fixed_8 --target=pir src/pct/actions.pm

##  cleaning
clean:
	$(RM_F) $(CLEANUPS)

realclean: clean
	$(RM_F) src/utils/Makefile Makefile

##  miscellaneous targets
# a listing of all targets meant to be called by users
help:
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "  all:               dectest.exe"
	@echo "                     This is the default."
	@echo "Cleaning:"
	@echo "  clean:             Basic cleaning up."
	@echo "  realclean:         Removes also files generated by 'Configure.pl'."
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""
